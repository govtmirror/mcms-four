<!--
@license
Copyright (c) 2016 dean wagner wagner@nmb.gov. All rights reserved.
-->

<dom-module id="mcms-caselist">

  <style>
    :host {
      display: block;
      box-sizing: border-box;
      font-family: 'Roboto', 'Noto', sans-serif;
      font-size: 14px;
      background-color: #eee;
      color: black;
      /*padding:10px;*/
      /*height: 75vh;*/
    }

    .mainlayout {
      @apply(--layout-horizontal);
    }

    .leftside {
      @apply(--layout-vertical);
      width:350px;
    }

    .rght {
      float: right;
    }

    .narrowbtn {
      display: none;
    }

    .flex-horizontal {
      @apply(--layout-horizontal);
      @apply(--layout-center);
    }
    .flexchild {
      @apply(--layout-flex);
    }

    .caseitem {
      border-radius: 10px;
      padding: 10px;
      margin:5px;
      background-color: var(--primary-background-color);
      color: black;
    }
    .listhead {
      background-color: var(--light-primary-color);
      padding:10px;
    }
    .caseselected {
      background-color: var(--paper-pink-a200);
      color: white;
    }
   
    .aaaa {
      height:85vh;
    }

    .bbbb {
      height:65px;
    }

    .bluecase {
      background-color: #ddddff;
      padding:20px;
      border-radius: 15px;
    }

    @media (max-width: 580px) {
      .mainlayout {
        @apply(--layout-vertical);
      }
      .leftside {
        width:100%;
      }
      .narrowbtn {
        display: inline;
      }
    }

  </style>

  <template>

  <div class="mainlayout">
    <div class="leftside">
      <div id="searchDiv" class="aaaa">
        <paper-header-panel 
            mode="waterfall">
          <div class="listhead">
            <div class="flex-horizontal">
              <paper-icon-button
                  icon="{{_toggleState}}"
                  disabled$="{{_toggleDisabled}}"
                  on-tap="_doSearchToggle">
              </paper-icon-button>
              <div class="flexchild">Search Form</div>
              <paper-icon-button
                  class="narrowbtn"
                  icon="{{_detailState}}"
                  disabled$="{{_detailDisabled}}"
                  on-tap="_toggledetail">
              </paper-icon-button>

              
            </div>
            <iron-collapse id="searchform">
              <hr>
              <paper-radio-button 
                  checked
                  id="getOpen" >
                Open
              </paper-radio-button>
              <paper-radio-button 
                  id="getTaed">
                Ta'ed
              </paper-radio-button>
              <paper-radio-button 
                  id="getClosed">
                Closed
              </paper-radio-button>
              <paper-input 
                  id="casetest"
                  label="Case number:" >
              </paper-input>
              <paper-input 
                  id="membertest"
                  label="NMB member:">
              </paper-input>
              <paper-input 
                  id="carriertest"
                  label="Carrier:">
              </paper-input>
              <paper-input 
                  id="orgtest"
                  label="Organization:">
              </paper-input>
              <div class="flex-horizontal">
                <div class="flexchild"></div>
                <paper-icon-button
                    icon="search"
                    on-tap="_doListSort">
                </paper-icon-button>
                <paper-icon-button
                    icon="clear"
                    on-tap="_doClearList">
                </paper-icon-button>
              </div>
            </iron-collapse>
          </div>
          <div id="actualList" class="">
            <template is="dom-repeat" 
                id="medcaselist"
                items="{{caselist}}"
                filter="isDisplay">
              <div on-tap="_itemtap" class="caseitem">



                    {{item.caseID}} {{item.caseSuffix}} 
                    <span class="rght">Docketed {{dateConvert(item.docketDate)}}</span>
                    <br>&nbsp;&nbsp;
                    
                    <template is="dom-repeat" items="{{item.carriers}}" as="piss">
                      {{piss}},&nbsp;
                    </template>
                  
                  
                    <template is="dom-repeat" items="{{item.orgs}}" as="shit">
                      {{shit}},<br>&nbsp;&nbsp;
                    </template>
                  

                    <template is="dom-repeat" items="{{item.nmbMembers}}" as="poop">
                      {{poop.name}},&nbsp;
                    </template>
              </div>
                
            </template>
          </div>
        </paper-header-panel>
      </div>
    </div>
    <mcms-casedetail
        selected-case="{{selectedCase}}">
    </mcms-casedetail>
  </div>
  

  </template>

  <script>

    Polymer({

      is: 'mcms-caselist',

      properties: {
        caselist: {
          type: Array,
          value: function () {
            return [];
          }
        },
        selectedCase: {
          type: Object,
          value: function () {
            return {};
          }
        },
        _toggleState: {
          type: String,
          value: "arrow-downward"
        },
        _detailState: {
          type: String,
          value: "description"
        },
        _toggleDisabled: {
          type: Boolean,
          value: false
        },
        _detailDisabled: {
          type: Boolean,
          value: false
        }

      },
      

      // Element Behavior

      _itemtap: function (event) {
        // remove caseselected class from all elements
        try {
          this.toggleClass('caseselected', false, this.$$('.caseselected'));
        } 
        catch(err) {
          console.log("no caseselected");
        }
        //  make the comparison to existing selected case
        var cid = event.model.item.__firebaseKey__;
        var isNewCase = true;
        if (this.selectedCase != null && cid == this.selectedCase.caseID ) {
          isNewCase = false;
        }
        //  set or not the case selected class
        if (event.target.nodeName != "DIV") {
          this.toggleClass('caseselected', isNewCase, event.target.parentNode);
        } else {
          this.toggleClass('caseselected', isNewCase, event.target);
        }
        
        this.fire('case-selected', {
          "caseId": event.model.item.__firebaseKey__,
          "isNewCase": isNewCase
        });
      },

      _doListSort: function () {
        this.$.medcaselist.render();
      },

      _doClearList: function () {
        this.$.getOpen.checked = false;
        this.$.getTaed.checked = false;
        this.$.getClosed.checked = false;
        this.$.casetest.value = "";
        this.$.membertest.value = "";
        this.$.carriertest.value = "";
        this.$.orgtest.value = "";
        // alert("_doClearList");
      },

      _doSearchToggle: function () {
        this.$.searchform.toggle();
        if (this.$.searchform.opened) {
          this._toggleState = "arrow-upward"
          this._detailDisabled = true;
        } else {
          this._toggleState = "arrow-downward"
          this._detailDisabled = false;
        }
      },
      _toggledetail: function () {
        if (this._detailState == "description") {
          this._detailState = "list";
          this.toggleClass('aaaa', false, this.$.searchDiv);
          this.toggleClass('bbbb', true, this.$.searchDiv);
          this._toggleDisabled = true;
        } else {
          this._detailState = "description";
          this.toggleClass('bbbb', false, this.$.searchDiv);
          this.toggleClass('aaaa', true, this.$.searchDiv);
          this._toggleDisabled = false;
        }
      },

      // utilities
      
      dateConvert: function (stringint) {
        if (stringint != "" && stringint != null){
          var d = new Date(parseInt(stringint));
          return d.toLocaleDateString();
        } else {
          return "n/a";
        }
      },

      isDisplay: function (item) {
        return this._getState(item) && 
               this._caseStartsWith(item) &&
               this._hasMember(item) &&
               this._hasCarrier(item) &&
               this._hasOrg(item);
      },
      
      _getState: function (item) {
        return (
          (item.caseState == "open" && this.$.getOpen.checked) ||
          (item.caseState == "closed" && this.$.getClosed.checked) ||
          (item.caseState == "taed" && this.$.getTaed.checked)
        );
      },

      _caseStartsWith: function (item) {
        var teststring = this.$.casetest.value;
        if (teststring) {
          return item.caseID.startsWith(teststring);
        } else {
          return true;
        }  
      },

      _hasMember: function (item) {
        var teststring = this.$.membertest.value;
        if (teststring) {
          var testresult = false;
          var testObject = item.nmbMembers;
          for (var prop in testObject) {
            if (!testObject.hasOwnProperty(prop)) {
              //The current property is not a direct property of p
              continue;
            }
            if (testObject[prop].name.startsWith(teststring)) {
              testresult = true;
            }
          }
          return testresult;
        } else {
          return true;
        }  
      },

      _hasCarrier: function (item) {
        var teststring = this.$.carriertest.value;
        if (teststring) {
          var testresult = false;
          var testObject = item.carriers;
          for (var prop in testObject) {
            if (!testObject.hasOwnProperty(prop)) {
              //The current property is not a direct property of p
              continue;
            }
            if (testObject[prop].startsWith(teststring)) {
              testresult = true;
            }
          }
          return testresult;
        } else {
          return true;
        }  
      },

      _hasOrg: function (item) {
        var teststring = this.$.orgtest.value;
        if (teststring) {
          var testresult = false;
          var testObject = item.orgs;
          for (var prop in testObject) {
            if (!testObject.hasOwnProperty(prop)) {
              //The current property is not a direct property of p
              continue;
            }
            if (testObject[prop].startsWith(teststring)) {
              testresult = true;
            }
          }
          return testresult;
        } else {
          return true;
        }  
      },

      _selectedStyle: function (id) {
        if (id == this.selectedCase.caseID) {
          return "caseitem caseselected";
        } else {
          return "caseitem";
        }
      }


    });

  </script>
</dom-module>